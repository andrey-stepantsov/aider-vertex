#!/usr/bin/env bash
set -e

# ./dev - The Aider-Vertex Orchestrator
# Usage: ./dev <target> [extra_flags]

if [ -z "$1" ]; then
    echo "Usage: ./dev <target> [--sys /path/to/includes]"
    exit 1
fi

TARGET="$1"; shift
# Capture remaining args (like --sys) to pass to weave-view
EXTRA_ARGS=("$@")

# --- 1. Target Resolution ---
if [ "$TARGET" == "full" ]; then
    echo "üöÄ Launching Full Context (Root Mode)..."
    aider-vertex
    exit 0
fi

TARGET_FILE="targets/${TARGET}.txt"
if [ ! -f "$TARGET_FILE" ]; then
    echo "‚ùå Error: Target definition '$TARGET_FILE' not found."
    exit 1
fi

echo "üìñ Reading target: $TARGET"
mapfile -t PATHS < "$TARGET_FILE"

# --- 2. Weave the View ---
VIEW_NAME="view-${TARGET}"
echo "üßµ Weaving view: $VIEW_NAME"

if ! command -v weave-view &> /dev/null; then
    echo "‚ùå Error: 'weave-view' not found. Are you in the devbox/docker env?"
    exit 1
fi

# Create the view (This defaults to linking the ROOT .ddd)
weave-view "$TARGET" "${PATHS[@]}" "${EXTRA_ARGS[@]}"

# --- 3. Smart DDD Linking (Nested Sovereignty) ---
# Check if the target paths imply a specific nested configuration.
# We take the first path in the target list and walk up the tree looking for .ddd
CANDIDATE_DDD=""
SEARCH_PATH="${PATHS[0]}"

# Handle relative paths by ensuring we start from PWD
if [[ "$SEARCH_PATH" != /* ]]; then SEARCH_PATH="$(pwd)/$SEARCH_PATH"; fi

# Walk up the tree until we hit the repo root
CURRENT_SEARCH="$SEARCH_PATH"
REPO_ROOT="$(pwd)"

while [[ "$CURRENT_SEARCH" != "$REPO_ROOT" && "$CURRENT_SEARCH" != "/" ]]; do
    if [ -d "$CURRENT_SEARCH/.ddd" ]; then
        CANDIDATE_DDD="$CURRENT_SEARCH/.ddd"
        break
    fi
    CURRENT_SEARCH="$(dirname "$CURRENT_SEARCH")"
done

# If we found a nested .ddd (and it's not the root one we already linked), relink it.
if [ -n "$CANDIDATE_DDD" ] && [ "$CANDIDATE_DDD" != "$REPO_ROOT/.ddd" ]; then
    echo "   [+] Detected Nested Config: $CANDIDATE_DDD"
    echo "   [+] Relinking View to Nested Daemon..."
    rm "$VIEW_NAME/.ddd"
    ln -sf "$CANDIDATE_DDD" "$VIEW_NAME/.ddd"
fi

# --- 4. Enter the Jail ---
cd "$VIEW_NAME"

# --- 5. The Git Bridge ---
# Trick Aider into thinking this is the repo root, but give it the REAL git database.
export GIT_DIR="$(git rev-parse --git-dir)"
export GIT_WORK_TREE="$(git rev-parse --show-toplevel)"

# --- 6. Credential Persistence ---
if [ -n "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
    export GOOGLE_APPLICATION_CREDENTIALS
fi

# --- 7. Launch ---
echo "üöÄ Launching Aider into $VIEW_NAME..."
# --root "$PWD": Forces Aider to accept the view as its universe.
aider-vertex --root "$PWD"