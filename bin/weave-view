#!/usr/bin/env bash
set -e

if [ "$#" -lt 2 ]; then
  echo "Usage: weave-view <view-name> <src-dir1> [src-dir2...] [--sys <sdk-dir1>...]"
  exit 1
fi

INPUT_NAME="$1"; shift
if [[ "$INPUT_NAME" == view-* ]]; then VIEW_NAME="$INPUT_NAME"; else VIEW_NAME="view-$INPUT_NAME"; fi

echo "ðŸ§µ Weaving virtual view: $VIEW_NAME"
mkdir -p "$VIEW_NAME/_sys"

JQ_ARGS=""; MODE=0
declare -a SRC_PATHS

for arg in "$@"; do
  if [ "$arg" == "--sys" ]; then MODE=1; continue; fi
  if [[ "$arg" = /* ]]; then ABS="$arg"; else ABS="$(pwd)/$arg"; fi
  
  if [ $MODE -eq 0 ]; then
    REL=$(dirname "$arg"); mkdir -p "$VIEW_NAME/$REL"
    ln -sf "$ABS" "$VIEW_NAME/$arg"
    SRC_PATHS+=("$ABS")
    if [ -z "$JQ_ARGS" ]; then JQ_ARGS=".file | startswith(\"$ABS\")";
    else JQ_ARGS="$JQ_ARGS or (.file | startswith(\"$ABS\"))"; fi
  else
    ln -sf "$ABS" "$VIEW_NAME/_sys/$(basename "$arg")"
  fi
done

echo "   [i] Searching for compilation databases..."
DB_LIST=$(mktemp)
if [ -f "compile_commands.json" ]; then echo "$(pwd)/compile_commands.json" >> $DB_LIST; fi
for path in "${SRC_PATHS[@]}"; do
    find "$path" -maxdepth 3 -name "compile_commands.json" >> $DB_LIST 2>/dev/null || true
done

UNIQUE_DBS=$(cat $DB_LIST | sort | uniq)
if [ ! -z "$UNIQUE_DBS" ] && [ ! -z "$JQ_ARGS" ]; then
    if command -v jq &> /dev/null; then
        echo "$UNIQUE_DBS" | xargs jq -s "add | [.[] | select($JQ_ARGS)]" > "$VIEW_NAME/compile_commands.json"
        echo "   [âœ“] Master compile_commands.json created."
    else
        echo "   [!] 'jq' not found. Skipping compile_commands.json generation."
    fi
else
    echo "   [!] No compilation databases found (or ignored)."
fi
rm -f $DB_LIST

echo "_sys/" > "$VIEW_NAME/.aiderignore"
if [ -f .aiderignore ]; then cat .aiderignore >> "$VIEW_NAME/.aiderignore"; fi

# --- TRIPLE-HEAD WIRING (SIMPLE) ---
# Just link the control directory. 
# The View shares the Daemon's reality.
if [ -d ".ddd" ]; then
    ln -sf "$(pwd)/.ddd" "$VIEW_NAME/.ddd"
    echo "   [+] Triple-Head Active: Linked .ddd/"
fi

echo "âœ… View Ready: cd $VIEW_NAME"
