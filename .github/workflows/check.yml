name: "CI Build Check"
on:
  push:
    branches:
      - main
      - 'agent/**'
      - 'ci/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  universal-check:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      # This is the magic setting: If ANY job in the matrix fails, cancel the others immediately.
      fail-fast: true
      matrix:
        include:
          - name: "Ubuntu (Nix)"
            os: ubuntu-latest
            type: standard
          - name: "macOS (Nix)"
            os: macos-latest
            type: standard
          - name: "CentOS 7 (Legacy Verify)"
            os: ubuntu-latest # We run on Ubuntu, but spawn a CentOS container
            type: centos-docker

    steps:
      - uses: actions/checkout@v4

      # --- STANDARD NIX BUILD STEPS (Ubuntu & macOS) ---
      - uses: cachix/install-nix-action@v31
        if: matrix.type == 'standard'
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Verify (Standard)
        if: matrix.type == 'standard'
        run: |
          nix build . -L
          ./result/bin/aider-vertex --version

      # --- CENTOS DOCKER STEP (Legacy Only) ---
      - name: Build & Run inside CentOS 7
        if: matrix.type == 'centos-docker'
        run: |
          docker run --rm -v $(pwd):/src -w /src centos:7 bash -c "
            set -e
            echo '>>> Fixing EOL Repositories...'
            sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
            sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
            
            echo '>>> Installing dependencies...'
            yum -y install curl xz git sudo
            
            echo '>>> Installing Nix...'
            curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --init none --no-confirm
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
            
            echo '>>> Running Verification...'
            nix run . -- --version
          "